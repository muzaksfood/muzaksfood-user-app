name: Deploy Flutter Web Incrementally with Full Cache-Busting

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FLUTTER_VERSION: 3.38.4  # Flutter version compatible with Dart 3.8.1+

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Download Flutter
      - name: Download Flutter
        run: |
          wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.38.4-stable.tar.xz
          tar xf flutter_linux_3.38.4-stable.tar.xz

      # 3. Add Flutter to PATH
      - name: Add Flutter to PATH
        run: echo "${PWD}/flutter/bin" >> $GITHUB_PATH

      # 4. Verify Flutter version
      - name: Flutter version
        run: flutter --version

      # 5. Cache pub packages
      - name: Cache pub packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/build
          key: ${{ runner.os }}-pubcache-${{ hashFiles('pubspec.lock') }}

      # 6. Get packages
      - name: Flutter pub get
        run: flutter pub get

      # 7. Build Flutter web
      - name: Build Flutter web
        run: flutter build web --release

      # 8. Install utilities
      - name: Install utilities
        run: sudo apt-get update && sudo apt-get install -y lftp rename

      # 9. Full cache-busting (JS, CSS, assets)
      - name: Cache-bust main JS, CSS, and assets
        run: |
          TIMESTAMP=$(date +%s)
          cd build/web

          # Cache-bust core files
          for file in main.dart.js flutter.js styles.css; do
            if [ -f "$file" ]; then
              NEW_FILE="${file%.*}.${TIMESTAMP}.${file##*.}"
              mv "$file" "$NEW_FILE"
              sed -i "s|$file|$NEW_FILE|g" index.html
            fi
          done

          # Cache-bust every asset referenced in index.html
          for asset in $(grep -oP 'src="\K[^"]+' index.html); do
            if [ -f "$asset" ]; then
              NEW_ASSET="${asset%.*}.${TIMESTAMP}.${asset##*.}"
              mv "$asset" "$NEW_ASSET"
              sed -i "s|$asset|$NEW_ASSET|g" index.html
            fi
          done

      # 10. Deploy via FTP (incremental)
      - name: Deploy to Namecheap
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          lftp -c "
          open -u $FTP_USERNAME,$FTP_PASSWORD $FTP_SERVER
          mirror -R --delete --verbose build/web $FTP_REMOTE_DIR
          bye
          "
