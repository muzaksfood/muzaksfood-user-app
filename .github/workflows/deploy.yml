name: Deploy Flutter Web Incrementally with Full Cache-Busting

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Download Flutter 3.27.1 (Dart 3.8.1)
      - name: Install Flutter 3.27.1
        run: |
          wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.27.1-stable.tar.xz
          tar -xf flutter_linux_3.27.1-stable.tar.xz
          echo "$PWD/flutter/bin" >> $GITHUB_PATH
          flutter --version

      # 3. Get dependencies
      - name: Flutter pub get
        run: flutter pub get

      # 4. Build Flutter web
      - name: Build Flutter web
        run: flutter build web --release

      # 5. Install utilities
      - name: Install utilities
        run: sudo apt-get update && sudo apt-get install -y lftp rename

      # 6. Cache-bust main JS, CSS, and assets
      - name: Cache-bust main JS, CSS, and assets
        run: |
          TIMESTAMP=$(date +%s)
          cd build/web
          # Rename main JS & CSS files
          for file in main.dart.js flutter.js styles.css; do
            if [ -f "$file" ]; then
              mv "$file" "${file%.*}.${TIMESTAMP}.${file##*.}"
              sed -i "s|$file|${file%.*}.${TIMESTAMP}.${file##*.}|g" index.html
            fi
          done
          # Rename other assets referenced in index.html
          for asset in $(grep -oP 'src="\K[^"]+' index.html); do
            if [ -f "$asset" ]; then
              HASH_FILE="${asset%.*}.${TIMESTAMP}.${asset##*.}"
              mv "$asset" "$HASH_FILE"
              sed -i "s|$asset|$HASH_FILE|g" index.html
            fi
          done

      # 7. Deploy to Namecheap
      - name: Deploy to Namecheap
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          lftp -c "
          open -u $FTP_USERNAME,$FTP_PASSWORD $FTP_SERVER
          mirror -R --delete --verbose build/web $FTP_REMOTE_DIR
          bye
          "
